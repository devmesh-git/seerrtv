name: Discord Notifications

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    types: [opened, closed]
  issues:
    types: [opened, closed]
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord - Tag Created
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          REF_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PAYLOAD=$(jq -n \
            --arg tag "$REF_NAME" \
            --arg repo "$REPO" \
            '{embeds:[{title:("üè∑Ô∏è New Tag: " + $tag),description:"A new tag was created in the repository",color:3447003,fields:[{name:"Tag",value:$tag,inline:true},{name:"Repository",value:$repo,inline:true}],url:("https://github.com/" + $repo + "/releases/tag/" + $tag)}]}')
          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK"

      - name: Notify Discord - Release Published
        if: github.event_name == 'release'
        env:
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_BODY_JSON: ${{ toJSON(github.event.release.body) }}
          REPO: ${{ github.repository }}
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          [ -z "$RELEASE_NAME" ] && RELEASE_NAME="$RELEASE_TAG"
          PAYLOAD=$(jq -n \
            --arg title "üéâ New Release: $RELEASE_TAG" \
            --argjson desc "$RELEASE_BODY_JSON" \
            --arg release "$RELEASE_NAME" \
            --arg tag "$RELEASE_TAG" \
            --arg url "https://github.com/$REPO/releases/tag/$RELEASE_TAG" \
            '{embeds:[{title:$title,description:$desc,color:3066993,fields:[{name:"Release",value:$release,inline:true},{name:"Tag",value:$tag,inline:true}],url:$url}]}')
          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK"

      - name: Notify Discord - Pull Request
        if: github.event_name == 'pull_request'
        env:
          ACTION: ${{ github.event.action }}
          PR_BODY_JSON: ${{ toJSON(github.event.pull_request.body) }}
          PR_TITLE_JSON: ${{ toJSON(github.event.pull_request.title) }}
          PR_NUM: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_STATE: ${{ github.event.pull_request.state }}
          REPO: ${{ github.repository }}
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ "$ACTION" = "closed" ]; then COLOR=15158332; STATUS="Closed"; else COLOR=3447003; STATUS="Opened"; fi
          PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --argjson title "$PR_TITLE_JSON" \
            --argjson desc "$PR_BODY_JSON" \
            --argjson color "$COLOR" \
            --arg pr "#$PR_NUM" \
            --arg author "$PR_AUTHOR" \
            --arg state "$PR_STATE" \
            --arg url "https://github.com/$REPO/pull/$PR_NUM" \
            '{embeds:[{title:("Pull Request " + $status + ": " + $title),description:$desc,color:$color,fields:[{name:"PR",value:$pr,inline:true},{name:"Author",value:$author,inline:true},{name:"Status",value:$state,inline:true}],url:$url}]}')
          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK"

      - name: Notify Discord - Issue
        if: github.event_name == 'issues'
        env:
          ACTION: ${{ github.event.action }}
          ISSUE_BODY_JSON: ${{ toJSON(github.event.issue.body) }}
          ISSUE_TITLE_JSON: ${{ toJSON(github.event.issue.title) }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
          REPO: ${{ github.repository }}
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ "$ACTION" = "closed" ]; then COLOR=15158332; STATUS="Closed"; else COLOR=3447003; STATUS="Opened"; fi
          LABELS="$ISSUE_LABELS"
          [ -z "$LABELS" ] && LABELS="None"
          PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --argjson title "$ISSUE_TITLE_JSON" \
            --argjson desc "$ISSUE_BODY_JSON" \
            --argjson color "$COLOR" \
            --arg issue "#$ISSUE_NUM" \
            --arg author "$ISSUE_AUTHOR" \
            --arg labels "$LABELS" \
            --arg url "https://github.com/$REPO/issues/$ISSUE_NUM" \
            '{embeds:[{title:("Issue " + $status + ": " + $title),description:$desc,color:$color,fields:[{name:"Issue",value:$issue,inline:true},{name:"Author",value:$author,inline:true},{name:"Labels",value:$labels,inline:false}],url:$url}]}')
          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK"
